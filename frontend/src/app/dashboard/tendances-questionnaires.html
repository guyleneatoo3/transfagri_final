<div class="p-4">
  <h2 class="text-xl font-semibold mb-3">Tendances des réponses aux questionnaires</h2>
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <div class="rounded bg-white shadow p-3 lg:col-span-1">
      <h3 class="font-medium mb-2">Questionnaires</h3>
      <ul class="divide-y">
        <li *ngFor="let q of questionnaires" class="py-2 flex items-center justify-between">
          <div>
            <div class="font-medium">{{ q.titre }}</div>
            <div class="text-xs text-gray-500">Lancé le: {{ q.sharedAt || q.createdAt }}</div>
          </div>
          <div class="flex gap-2">
            <button class="px-3 py-1 rounded bg-blue-600 text-white" (click)="select(q)">Voir tendance</button>
            <button class="px-3 py-1 rounded bg-emerald-600 text-white" (click)="genererRapport(q)">Générer rapport</button>
          </div>
        </li>
      </ul>
    </div>
    <div class="rounded bg-white shadow p-3 lg:col-span-2" *ngIf="selected as sel">
      <h3 class="font-medium mb-2">Tendance: {{ sel.titre }}</h3>
      <div *ngIf="loading" class="text-sm text-gray-500">Chargement…</div>
      <div *ngIf="error" class="text-sm text-rose-600">{{ error }}</div>
  <div *ngIf="info && !error" class="text-sm text-emerald-700">{{ info }}</div>
      <div *ngIf="!loading && !error">
        <div class="text-sm text-slate-600 mb-2">Total réponses: {{ stats.totalReponses }}</div>
        <div *ngFor="let q of stats.questions" class="mb-3">
          <div class="font-medium">{{ q.label }}</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-1">
            <div *ngFor="let opt of q.options" class="text-sm flex items-center justify-between bg-slate-50 rounded px-2 py-1">
              <span>{{ opt }}</span>
              <span class="font-semibold">{{ q.counts[opt] || 0 }}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-3">
        <button class="px-3 py-1 rounded bg-indigo-600 text-white" (click)="sel.id ? resumerAvecIA(sel.id) : null">Résumer avec l'IA</button>
      </div>
    </div>
  </div>

  <!-- Popup résumé IA -->
  <div *ngIf="showSummary" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white rounded shadow-lg max-w-xl w-full p-4">
      <div class="font-semibold mb-2">Résumé des tendances</div>
      <pre class="whitespace-pre-wrap text-sm text-gray-700">{{ aiSummary }}</pre>
      <div class="text-right mt-4">
        <button class="px-3 py-1 mr-2 rounded bg-emerald-600 text-white" (click)="saveSummary()">Enregistrer le rapport</button>
        <button class="px-3 py-1 rounded bg-gray-700 text-white" (click)="showSummary=false">Fermer</button>
      </div>
    </div>
  </div>
</div>
