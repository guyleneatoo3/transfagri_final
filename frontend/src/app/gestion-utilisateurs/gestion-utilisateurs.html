<h6 class="page-title">👤 Gestion des utilisateurs</h6>

<!-- Filtres par rôle -->
<div class="card" style="padding:12px; margin-bottom:12px; display:flex; gap:8px; flex-wrap:wrap;">
  <button class="btn" [class.btn-primary]="!selectedRole" (click)="setRoleFilter(null)">Tous</button>
  <button class="btn" [class.btn-primary]="selectedRole==='ADMIN'" (click)="setRoleFilter('ADMIN')">Admins</button>
  <button class="btn" [class.btn-primary]="selectedRole==='CNEF'" (click)="setRoleFilter('CNEF')">CNEF</button>
  <button class="btn" [class.btn-primary]="selectedRole==='EMF'" (click)="setRoleFilter('EMF')">EMF</button>
  <button class="btn" [class.btn-primary]="selectedRole==='PASNFI'" (click)="setRoleFilter('PASNFI')">PASNFI</button>
</div>

<!-- Formulaire de création -->
<div class="card form-section">
  <h3 class="section-title">➕ Ajouter un utilisateur</h3>
  <div class="form-grid">
    <input [(ngModel)]="nouvelUtilisateur.nom" placeholder="Nom" />
    <input [(ngModel)]="nouvelUtilisateur.email" placeholder="Email" />
    <input [(ngModel)]="nouvelUtilisateur.motdepasse" placeholder="Mot de passe" type="password" />
    <select [(ngModel)]="nouvelUtilisateur.role">
      <option value="ROLE_ADMIN">ADMIN</option>
      <option value="ROLE_CNEF">CNEF</option>
      <option value="ROLE_EMF">EMF</option>
      <option value="ROLE_PASNFI">PASNFI</option>
    </select>
    <button class="btn btn-primary" (click)="creerUtilisateur()">Créer</button>
  </div>
  <div class="text-success" *ngIf="message">{{ message }}</div>
  <div class="text-danger" *ngIf="!message && utilisateurs.length===0">Aucun utilisateur</div>
  <div class="search-inline-wrapper" style="margin-top:8px;">
    <input [(ngModel)]="recherche" class="search-input-inline" placeholder="🔍 Rechercher (nom, email, rôle)" />
    <button *ngIf="recherche" (click)="recherche = ''" class="btn-reset" title="Réinitialiser">🔄</button>
  </div>
</div>

<!-- Liste des utilisateurs -->
<div class="card table-section">
  <h3 class="section-title">📋 Liste des utilisateurs</h3>
  <table class="emf-table">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Email</th>
        <th>Rôle</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let utilisateur of utilisateursFiltres">
        <ng-container *ngIf="utilisateurEnEdition?.idutilisateur !== utilisateur.idutilisateur; else edition">
          <td>{{ utilisateur.nom }}</td>
          <td>{{ utilisateur.email }}</td>
          <td>{{ utilisateur.role }}</td>
          <td>
            <button class="btn btn-edit" (click)="modifierUtilisateur(utilisateur)">✏️</button>
            <button class="btn btn-delete" (click)="supprimerUtilisateur(utilisateur.idutilisateur || utilisateur.id)">🗑️</button>
          </td>
        </ng-container>

        <ng-template #edition>
          <td><input [(ngModel)]="utilisateurEnEdition!.nom" /></td>
          <td><input [(ngModel)]="utilisateurEnEdition!.email" /></td>
          <td>
            <select [(ngModel)]="utilisateurEnEdition!.role">
              <option value="ROLE_ADMIN">ADMIN</option>
              <option value="ROLE_CNEF">CNEF</option>
              <option value="ROLE_EMF">EMF</option>
              <option value="ROLE_PASNFI">PASNFI</option>
            </select>
          </td>
          <td>
            <button class="btn btn-save" (click)="enregistrerModification()">💾</button>
            <button class="btn btn-cancel" (click)="annulerModification()">❌</button>
          </td>
        </ng-template>
      </tr>
    </tbody>
  </table>
</div>
